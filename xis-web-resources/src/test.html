<!DOCTYPE html>
<html>
<head>
    <title>123</title>
    <script>


class PageController {

    /**
     * @param {Client} client
     * @param {Pages} pages
     * @param {Initializer} initializer
     */
    constructor(client, pages, initializer) {
        this.client = client;
        this.pages = pages;
        this.initializer = initializer;
        this.head = getElementByTagName('head');
        this.body = getElementByTagName('body');
        this.title = getElementByTagName('title');
        this.pageDataMap = {};
        this.pageAttributes = {};
        this.pageId = undefined;
        this.titleExpression;
    }

    /**
     * @public
     * @param {Config} config
     */
    displayInitialPage(config) {
        console.log('PageController - displayInitialPage');
        this.pageAttributes = config.pageAttributes;
        var _this = this;
        this.findPageForCurrentUrl()
            .then(page => _this.bindPage(page))
            .then(pageId => _this.refreshData(pageId))
            .then(pageId => _this.refreshPage(pageId))
            .catch(e => console.error(e));
    }

    bindPageById(id) {
        return this.bindPage(this.pages.getPageById(id));
    }

    /**
    * @returns {Promise<string>}
    */
    bindPage(page) {
        var _this = this;
        return new Promise((resolve, _) => {
            _this.clearHeadChildNodes();
            _this.clearBodyChildNodes();
            _this.clearBodyAttributes();
            _this.bindTitle(page);
            _this.bindHeadChildNodes(page.headChildArray);
            _this.bindBodyAttributes(page.bodyAttributes);
            _this.bindBodyChildNodes(page.bodyChildArray)
            resolve(page.id);
        }).catch(e => console.error('failed to bind page:' + e));
    }

    bindHeadChildNodes(nodeArray) {
        for (var node of nodeArray) {
            if (node.nodeType == 1 && node.localName == 'title') {
                continue;
            }
            this.head.appendChild(node);
        }
    }

    /**
     *
     * @param {string} title
     */
    bindTitle(page) {
        if (page.headChildArray) {
            for (var child of page.headChildArray) {
                console.log('bindTitle - child:' + child.localName);
                if (isElement(child) && child.localName == 'title') {
                    var title = child.innerText;
                    console.log('bindTitle - title:' + title);
                    if (!title) {
                        return;
                    }
                    if (title.indexOf('${') != -1) {
                        this.title.expression = new TextContentParser(attrValue).parse()
                    } else {
                        this.title.innerText = title;
                    }
                }
            }
        }
    }

    bindBodyChildNodes(nodeArray) {
        this.bindChildNodes(this.body, nodeArray);
    }

    bindChildNodes(element, nodeArray) {
        for (var node of nodeArray) {
            element.appendChild(node);
        }
    }

    bindBodyAttributes(attributes) {
        for (var name of Object.keys(attributes)) {
            this.body.setAttribute(name, attributes[name]);
        }
        this.initializer.initializeAttributes(this.body);
    }

    clearBodyAttributes() {
        for (var name of this.body.getAttributeNames()) {
            this.body.removeAttribute(name);
        }
        console.log('clearBodyAttributes:' + this.body);
        this.body._attributes = undefined;
    }

    clearHeadChildNodes() {
        this.clearChildren(this.head);
    }

    clearBodyChildNodes() {
        this.clearChildren(this.body);
    }

    clearChildren(element) {
        for (var node of nodeListToArray(element.childNodes)) {
            if (node.getAttribute && node.getAttribute('ignore')) {
                continue;
            }
            element.removeChild(node);
        }
    }

    unbindPage() {
        for (var name of this.body.getAttributeNames()) {
            this.body.removeAttribute(name);
        }
        for (var child of nodeListToArray(this.body.childNodes)) {
            if (!child.getAttribute || !child.getAttribute('ignore')) {
                this.body.removeChild(child);
            }
        }
        for (var child of nodeListToArray(this.head.childNodes)) {
            if (!child.getAttribute || !child.getAttribute('ignore')) {
                this.head.removeChild(child);
            }
        }
        this.titleExpression = undefined;
    }

    /**
     * @returns {Promise<string>}
     */
    findPageForCurrentUrl() {
        console.log('findPageId');
        return new Promise((resolve, _) => {
            var uri = document.location.pathname;
            var page = this.pages.getPageById(uri);
            if (!page) {
                page = this.pages.getWelcomePage();
            }
            console.log('resolve findPageId: ' + uri);
            console.log('resolve findPageId: ' + page);
            resolve(page);
        });
    }

    /**
    * @private
    * @param {string} pageId
    * @returns {Promise<string>}
    */
    refreshData(pageId) {
        var _this = this;
        console.log('refreshData:' + pageId);
        var values = {};
        console.log('pageDataMap:' + this.pageDataMap);
        var pageData = this.pageDataMap[pageId];
        var pageAttributes = this.pageAttributes[pageId];
        console.log('attributes:' + JSON.stringify(this.pageAttributes));
        if (pageData) {
            for (var dataKey of pageAttributes.modelsToSubmitForModel) {
                values[dataKey] = pageData.getValue([dataKey]);
            }
        }
        return this.client.loadPageData(pageId, values).then(response => {
            _this.pageDataMap[pageId] = new Data(response.data);
            return pageId;
        });
    }

    /**
    * @private
    * @param {string} pageId
    * @returns {Promise<string>}
    */
    refreshPage(pageId) {
        var _this = this;
        return new Promise((resolve, _) => {
            var data = _this.pageDataMap[pageId];
            _this.refreshTitle(data);
            refreshNode(_this.head, data);
            refreshNode(_this.body, data);
            _this.updateHistory(pageId);
            console.log('resolve - refreshPage: ' + pageId);
            resolve(pageId);
        });
    }

    /**
     * @private
     * @param {Data} data
     */
    refreshTitle(data) {
        if (this.titleExpression) {
            this.title.innerHTML = this.titleExpression.evaluate(data);
        }
    }

    /**
     * @private
     * Changes value diplayed in browsers address-input.
     * @param {string} pageId
     */
    updateHistory(pageId) {
        var title = getElementByTagName('title').innerHTML;
        window.history.replaceState({}, title, pageId);
    }
}
/**
 * @param {Node} node
 * @returns {boolean}
 */
function isElement(node) {
    return node.nodeType == 1;
}

/**
 * Finds a unique element
 *
 * @param {string} name
 * @returns
 */
function getElementByTagName(name) {
    var list = document.getElementsByTagName(name);
    switch (list.length) {
        case 0: return null;
        case 1: return list.item(0);
        default: throw new Error('too many results for ' + name);
    }
}

/**
 *
 * @param {Element} parent
 * @param {string} childName
 * @returns {Element}
 */
function getChildElementByName(parent, childName) {
    for (var i = 0; i < parent.childNodes.length; i++) {
        var child = parent.childNodes.item(i);
        if (isElement(child) && child.localName == childName) {
            return child;
        }
    }
}
/**
 * Maps a NodeList into an array.
 *
 * @public
 * @param {NodeList} nodeList
 * @returns {Array}
 */
function nodeListToArray(nodeList) {
    var arr = [];
    for (var i = 0; i < nodeList.length; i++) {
        arr.push(nodeList.item(i));
    }
    return arr;
}

/**
 *
 * @param {string} str
 * @returns
 */
function trim(str) {
    var start = 0;
    for (; start < str.length; start++) {
        if (!isWhitespace(str.charAt(start))) {
            break;
        }
    }
    var end = str.length - 1;
    for (; end >= start; end--) {
        if (!isWhitespace(str.charAt(end))) {
            break;
        }
    }
    return str.substring(start, end + 1);

}


function isWhitespace(c) {
    return c == ' ' || c == '\t' || c == '\n' || c == '\r';
}

function cloneArr(arr) {
    return arr.map(v => v);
}


function doSplit(string, separatorChar) {
    var rv = [];
    var buffer = '';
    for (var i = 0; i < string.length; i++) {
        var c = string.charAt(i);
        if (c === separatorChar) {
            rv.push(buffer);
            buffer = '';
        } else {
            buffer += c;
        }
    }
    rv.push(buffer);
    return rv;
}

/**
 * For better mocking
 * @param {string} name
 */
function createElement(name) {
    return document.createElement(name);
}

/**
 * Hierarchical page-data
 */
class Data {

    /**
     *
     * @param {any} values
     */
    constructor(values, parentData = undefined) {
        this.values = values;
        this.parentData = parentData;
    }
    /**
     * @public
     * @param {Array<string>} path the path of the data value
     * @returns {any}
     */
    getValue(path) {
        var dataNode = this.values;
        for (var i = 0; i < path.length; i++) {
            var key = path[i];
            if (dataNode[key]) {
                dataNode = dataNode[key];
            } else {
                dataNode = undefined;
                break;
            }
        }
        if (dataNode === undefined && this.parentData) {
            return this.parentData.getValue(path)
        }
        return dataNode;
    }

    getKeys() {
        return Object.keys(this.values);
    }

    /**
     * @public
     * @param {String} key
     * @param {any} value
     */
    setValue(key, value) {
        this.values[key] = value;
    }
}

class Initializer {

    /**
     *
     * @param {DomAccessor} domAccessor
     */
    constructor(domAccessor) {
        this.domAccessor = domAccessor;
    }


    initialize(node) {
        console.log('initialize:' + node);
        if (isElement(node) && !node.getAttribute('ignore')) {
            this.initializeElement(node);
        } else {
            this.initializeTextNode(node);
        }
    }

    initializeElement(element) {
        console.log('initializeElement:' + element);
        if (this.isFrameworkElement(element)) {
            this.initializeFrameworkElement(element);
        } else {
            this.initializeHtmlElement(element);
        }
        this.initializeChildNodes(element);
    }

    /**
    * Initializes a html-element, which means
    * this is not a xis-element like <xis:foreach/>
    * @param {Element} element
    */
    initializeHtmlElement(element) {
        console.log('initializeHtmlElement:' + element);
        if (element.getAttribute('repeat')) {
            this.initializeRepeat(element);
        }
        if (element.getAttribute('for')) {
            this.initializeFor(element);
        }
        this.initializeAttributes(element);
    }

    initializeAttributes(element) {
        console.log('initializeAttributes:' + element);
        element._attributes = [];
        for (var attrName of element.getAttributeNames()) {
            var attrValue = element.getAttribute(attrName);
            if (attrValue.indexOf('${') != -1) {
                element._attributes.push({
                    name: attrName,
                    expression: new TextContentParser(attrValue).parse()
                });
            }
        }
    }

    /**
     * @private
     * @param {Element} element
     */
    initializeTextNode(node) {
        if (node.nodeValue && node.nodeValue.indexOf('${') != -1) {
            node._expression = new TextContentParser(node.nodeValue).parse();
        }
    }

    initializeFrameworkElement(element) {
        console.log('initializeFrameworkElement:' + element);
        switch (element.localName) {
            case 'xis:foreach':
            case 'xis:forEach':
                this.decorateForeach(element);
                break;
            case 'xis:widget-container':
                this.decorateContainer(element);
        }
    }

    initializeChildNodes(element) {
        console.log('initializeChildNodes:' + element);
        for (var index = 0; index < element.childNodes.length; index++) {
            var child = element.childNodes.item(index);
            this.initialize(child);
        }
    }
    /**
    * @private
    * @param {Element} element
    */
    initializeRepeat(element) {
        console.log('initializeRepeat:' + element);
        var arr = doSplit(element.getAttribute('repeat'), ':');
        element.removeAttribute('repeat');
        var foreach = this.createForEach(arr[0], arr[1]);
        this.domAccessor.insertParent(element, foreach);
    }


    /**
    * @private
    * @param {Element} element
    */
    initializeFor(element) {
        var arr = doSplit(element.getAttribute('for'), ':');
        element.removeAttribute('for');
        var foreach = this.createForEach(arr[0], arr[1]);
        this.domAccessor.insertChild(element, foreach);
    }

    createForEach(varName, array) {
        var foreach = document.createElement('xis:foreach');
        foreach.setAttribute('var', varName);
        foreach.setAttribute('array', array);
        return this.decorateForeach(foreach);
    }

    decorateForeach(foreach) {
        foreach._handler = new ForeachHandler(foreach, this);
        return foreach;
    }

    decorateContainer(container) {
        container._handler = new WidgetContainerHandler(container);
        return container;
    }


    isFrameworkElement(element) {
        return element.localName.startsWith('xis:');
    }

}
class Refresher {


    refreshNode(node, data) {
        if (isElement(node, data)) {
            this.refreshElement(node, data);
        } else {
            this.refreshTextNode(node, data);
        }
    }

    /**
     *
     * @param {Element} element
     * @param {Data} data
     */
    refreshElement(element, data) {
        if (element._attributes) {
            for (var attribute of this._attributes) {
                this.setAttribute(attribute.name, attribute.expression.evaluate(data));
            }
        }
        if (element._handler) {
            element._handler.refresh(data); // invokes child modes, too
        } else {
            for (var i = 0; i < element.childNodes.length; i++) {
                var child = element.childNodes.item(i);
                this.refreshNode(child);
            }
        }
    }

    refreshTextNode(node, data) {
        if (node._expression) {
            node.nodeValue = node._expression.evaluate(data);
        }
    }
}

var refresher = new Refresher();

function refreshNode(node, data) {
    refresher.refreshNode(node, data);
}
var div1 = document.createElement('div');
var div2 = document.createElement('div');
div1.appendChild(div2);

var titleElement = document.createElement('title');
titleElement.innerText = 'Test'

var headChildArray = [document.createElement('style'), document.createElement('script'), titleElement];
var bodyChildArray = [div1];


var page = {
    id : 'index.html',
    headChildArray: headChildArray,
    bodyChildArray: bodyChildArray,
    bodyAttributes: { class: 'test' }
};


var dataResponse = {
    data: {
        test: 123
    }
};

var config = {
    welcomePageId: 'index.html',
    pageAttributes : {
        'index.html' : {
            modelsToSubmitForModel: []
        }
    }
}


var pages = {
    getPageById: function (id) { return page; }
};

var client = {

    loadPageData: function (pageId, values) {
        return new Promise((resolve, reject) => {
            resolve(dataResponse);
        });
    }
}
function test() {
    var pageController = new PageController(client, pages, new Initializer());
    pageController.displayInitialPage(config);
}






    </script>
</head>
<body onload="test()"></body>
</html>