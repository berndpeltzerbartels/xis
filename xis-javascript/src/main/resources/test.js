var categories = [
    {
        title: 'Küche', products: [
            { title: 'Kochtopf', price: 12.5 },
            { title: 'Braftpfanne', price: 12.5 },
            { title: 'Topflappen', price: 12.5 },
            { title: 'Espressokocher', price: 12.5 }
        ]
    },
    {
        title: 'Bad', products: [
            { title: 'Vorleger', price: 12.5 },
            { title: 'Klobürste', price: 12.5 }
        ]
    },
    {
        title: 'Küche', products: [
            { title: 'Kochtopf', price: 12.5 },
            { title: 'Braftpfanne', price: 12.5 },
            { title: 'Topflappen', price: 12.5 },
            { title: 'Espressokocher', price: 12.5 }
        ]
    },
    {
        title: 'Bad', products: [
            { title: 'Vorleger', price: 12.5 },
            { title: 'Klobürste', price: 12.5 }
        ]
    },
    {
        title: 'Küche', products: [
            { title: 'Kochtopf', price: 12.5 },
            { title: 'Braftpfanne', price: 12.5 },
            { title: 'Topflappen', price: 12.5 },
            { title: 'Espressokocher', price: 12.5 }
        ]
    },
    {
        title: 'Bad', products: [
            { title: 'Vorleger', price: 12.5 },
            { title: 'Klobürste', price: 12.5 }
        ]
    },
    {
        title: 'Küche', products: [
            { title: 'Kochtopf', price: 12.5 },
            { title: 'Braftpfanne', price: 12.5 },
            { title: 'Topflappen', price: 12.5 },
            { title: 'Espressokocher', price: 12.5 }
        ]
    },
    {
        title: 'Bad', products: [
            { title: 'Vorleger', price: 12.5 },
            { title: 'Klobürste', price: 12.5 }
        ]
    },
    {
        title: 'Küche', products: [
            { title: 'Kochtopf', price: 12.5 },
            { title: 'Braftpfanne', price: 12.5 },
            { title: 'Topflappen', price: 12.5 },
            { title: 'Espressokocher', price: 12.5 }
        ]
    },
    {
        title: 'Bad', products: [
            { title: 'Vorleger', price: 12.5 },
            { title: 'Klobürste', price: 12.5 }
        ]
    },
    {
        title: 'Küche', products: [
            { title: 'Kochtopf', price: 12.5 },
            { title: 'Braftpfanne', price: 12.5 },
            { title: 'Topflappen', price: 12.5 },
            { title: 'Espressokocher', price: 12.5 }
        ]
    },
    {
        title: 'Bad', products: [
            { title: 'Vorleger', price: 12.5 },
            { title: 'Klobürste', price: 12.5 }
        ]
    },
    {
        title: 'Küche', products: [
            { title: 'Kochtopf', price: 12.5 },
            { title: 'Braftpfanne', price: 12.5 },
            { title: 'Topflappen', price: 12.5 },
            { title: 'Espressokocher', price: 12.5 }
        ]
    },
    {
        title: 'Bad', products: [
            { title: 'Vorleger', price: 12.5 },
            { title: 'Klobürste', price: 12.5 }
        ]
    },
    {
        title: 'Küche', products: [
            { title: 'Kochtopf', price: 12.5 },
            { title: 'Braftpfanne', price: 12.5 },
            { title: 'Topflappen', price: 12.5 },
            { title: 'Espressokocher', price: 12.5 }
        ]
    },
    {
        title: 'Bad', products: [
            { title: 'Vorleger', price: 12.5 },
            { title: 'Klobürste', price: 12.5 }
        ]
    },
    {
        title: 'Küche', products: [
            { title: 'Kochtopf', price: 12.5 },
            { title: 'Braftpfanne', price: 12.5 },
            { title: 'Topflappen', price: 12.5 },
            { title: 'Espressokocher', price: 12.5 }
        ]
    },
    {
        title: 'Bad', products: [
            { title: 'Vorleger', price: 12.5 },
            { title: 'Klobürste', price: 12.5 }
        ]
    },
    {
        title: 'Küche', products: [
            { title: 'Kochtopf', price: 12.5 },
            { title: 'Braftpfanne', price: 12.5 },
            { title: 'Topflappen', price: 12.5 },
            { title: 'Espressokocher', price: 12.5 }
        ]
    },
    {
        title: 'Bad', products: [
            { title: 'Vorleger', price: 12.5 },
            { title: 'Klobürste', price: 12.5 }
        ]
    },
    {
        title: 'Küche', products: [
            { title: 'Kochtopf', price: 12.5 },
            { title: 'Braftpfanne', price: 12.5 },
            { title: 'Topflappen', price: 12.5 },
            { title: 'Espressokocher', price: 12.5 }
        ]
    },
    {
        title: 'Bad', products: [
            { title: 'Vorleger', price: 12.5 },
            { title: 'Klobürste', price: 12.5 }
        ]
    },
    {
        title: 'Küche', products: [
            { title: 'Kochtopf', price: 12.5 },
            { title: 'Braftpfanne', price: 12.5 },
            { title: 'Topflappen', price: 12.5 },
            { title: 'Espressokocher', price: 12.5 }
        ]
    },
    {
        title: 'Bad', products: [
            { title: 'Vorleger', price: 12.5 },
            { title: 'Klobürste', price: 12.5 }
        ]
    },
    {
        title: 'Küche', products: [
            { title: 'Kochtopf', price: 12.5 },
            { title: 'Braftpfanne', price: 12.5 },
            { title: 'Topflappen', price: 12.5 },
            { title: 'Espressokocher', price: 12.5 }
        ]
    },
    {
        title: 'Bad', products: [
            { title: 'Vorleger', price: 12.5 },
            { title: 'Klobürste', price: 12.5 }
        ]
    },
    {
        title: 'Küche', products: [
            { title: 'Kochtopf', price: 12.5 },
            { title: 'Braftpfanne', price: 12.5 },
            { title: 'Topflappen', price: 12.5 },
            { title: 'Espressokocher', price: 12.5 }
        ]
    },
    {
        title: 'Bad', products: [
            { title: 'Vorleger', price: 12.5 },
            { title: 'Klobürste', price: 12.5 }
        ]
    },
    {
        title: 'Küche', products: [
            { title: 'Kochtopf', price: 12.5 },
            { title: 'Braftpfanne', price: 12.5 },
            { title: 'Topflappen', price: 12.5 },
            { title: 'Espressokocher', price: 12.5 }
        ]
    },
    {
        title: 'Bad', products: [
            { title: 'Vorleger', price: 12.5 },
            { title: 'Klobürste', price: 12.5 }
        ]
    },
    {
        title: 'Küche', products: [
            { title: 'Kochtopf', price: 12.5 },
            { title: 'Braftpfanne', price: 12.5 },
            { title: 'Topflappen', price: 12.5 },
            { title: 'Espressokocher', price: 12.5 }
        ]
    },
    {
        title: 'Bad', products: [
            { title: 'Vorleger', price: 12.5 },
            { title: 'Klobürste', price: 12.5 }
        ]
    },
    {
        title: 'Küche', products: [
            { title: 'Kochtopf', price: 12.5 },
            { title: 'Braftpfanne', price: 12.5 },
            { title: 'Topflappen', price: 12.5 },
            { title: 'Espressokocher', price: 12.5 }
        ]
    },
    {
        title: 'Bad', products: [
            { title: 'Vorleger', price: 12.5 },
            { title: 'Klobürste', price: 12.5 }
        ]
    },
    {
        title: 'Küche', products: [
            { title: 'Kochtopf', price: 12.5 },
            { title: 'Braftpfanne', price: 12.5 },
            { title: 'Topflappen', price: 12.5 },
            { title: 'Espressokocher', price: 12.5 }
        ]
    },
    {
        title: 'Bad', products: [
            { title: 'Vorleger', price: 12.5 },
            { title: 'Klobürste', price: 12.5 }
        ]
    },
    {
        title: 'Küche', products: [
            { title: 'Kochtopf', price: 12.5 },
            { title: 'Braftpfanne', price: 12.5 },
            { title: 'Topflappen', price: 12.5 },
            { title: 'Espressokocher', price: 12.5 }
        ]
    },
    {
        title: 'Bad', products: [
            { title: 'Vorleger', price: 12.5 },
            { title: 'Klobürste', price: 12.5 }
        ]
    },
    {
        title: 'Küche', products: [
            { title: 'Kochtopf', price: 12.5 },
            { title: 'Braftpfanne', price: 12.5 },
            { title: 'Topflappen', price: 12.5 },
            { title: 'Espressokocher', price: 12.5 }
        ]
    },
    {
        title: 'Bad', products: [
            { title: 'Vorleger', price: 12.5 },
            { title: 'Klobürste', price: 12.5 }
        ]
    }

];


function createElement(tagName, attributes = {}) {
    var e = document.createElement(tagName);
    for (var name of Object.keys(attributes)) {
        e.setAttribute(name, attributes[name]);
    }
    return e;
}



function createTextNode() {
    return document.createTextNode('');
}



class LoopAttributes {
    arrayPath = [];
    itemVarName;
    indexVarName;
    numberVarName;
}



class XISElement {

    constructor() {
        this.element = this.createElement();
        this.children = this.createChildren();
    }

    init(parent) {
        this.parent = parent;
        this.parent.element.appendChild(this.element);
        for (var child of this.children) {
            child.init(this);
        }
    }

    getValue(path) {
        return this.parent.getValue(path);
    }

    update() {
        if (this.evalIf()) {
            for (var child of this.children) {
                child.update();
            }
        } else {
            this.unlink();
        }
    }

    evalIf() {
        return true;
    }


    createElement() {
        // abstract
    }

    createChildren() {
        // abstract
     return [];
    }

    unlink() {
        this.parent.removeChild(this.element);
    }

    attrVal(name) {
        var val = '';
        switch (name) {
            case 'style':
                val += 'color:red';
                break;
            case 'onmouseover':
                val += fkt(this.parent.getValue('bla')); 
                break;
        }
        return val;
    }

}


class XISTextNode {
    
    constructor() {
        this.node = createTextNode();
    }

    init(parent) {
        this.parent = parent;
        this.parent.element.appendChild(this.node);
    }

    update() {
        var text = this.getText();
        if (this.node.nodeValue != text) {
            this.node.nodeValue = text;
        }
    }

    getText() {
        // abstract
    }
}

class XISLoopElement {

    constructor(loopAttributes) {
        this.loopAttributes = loopAttributes;
        this.element = this.createElement();
        this.rows = [];
    }

    init(parent) {
        this.parent = parent;
        this.parent.element.appendChild(this.element);
        this.names = [this.loopAttributes .itemVarName, this.loopAttributes .indexVarName, this.loopAttributes .numberVarName];
    }

    createElement() {
        // abstract
    }

    createChildren() {
           // abstract
        return [];
    }

    unlink() {
        this.parent.removeChild(this.element);
    }

    update() {
        this.data = [];
        this.values = [];
        if (this.evalIf()) {
            this.data = this.getArray();
            this.resize(this.data.length);
            for (var i = 0; i < this.data.length; i++) {
                this.values  = [];
                this.values[this.loopAttributes.itemVarName] = this.data[i];
                this.values[this.loopAttributes.indexVarName] = i;
                this.values[this.loopAttributes.numberVarName] = i + 1;
                var children = this.rows[i];
                for (var j = 0; j < children.length; j++) {
                    children[j].update();
                }
            }
        }
    }

    getValue(path) {
        var name = path[0];
        if (this.names.indexOf(name) != -1) {
            var rv = this.values[name];
            for (var i = 1; i < path.length; i++) {
                if (!rv) {
                    return undefined;
                }
                rv = rv[path[i]];
            }
            return rv;
        }
        if (this.parent) {
            return this.parent.getValue(path);
        }
    }

    getArray() {
        return this.parent.getValue(this.loopAttributes.arrayPath);
    }

    resize(size) {
        while (this.rowCount() < size) {
            this.appendRow();
        }
        while (this.rowCount() > size) {
            this.removeRow();
        }
    }

    rowCount() {
        return this.rows.length;
    }


    appendRow() {
        var children = this.createChildren();
        for (var i = 0; i < children.length; i++) {
            children[i].init(this);
        }
        this.rows.push(children);
    }

    removeRow() {
        if (this.rows.length > 0) {
            var children = this.rows.pop();
            for (var i = 0; i < children.length; i++) {
                this.element.removeChild(children[i].element);
            }
        }
    }

    evalIf() {
        return true;
    }


} 

class XISRoot {
    
    constructor(clientState) {
        this.clientState = clientState;
        this.element = this.createElement();
    }

    init(parentElement) {
        this.parentElement = parentElement;
        this.parentElement.appendChild(this.element);
    }

    setWidget(widget) {
       if (this.widget) {
           this.element.removeChild(this.widget.element);
       }
       this.widget = widget;
       this.widget.init(this);
       this.widget.update();     
    }

    getValue(path) {
        var name = path[0];
        var rv = this.clientState[name];
        for (var i = 1; i < path.length; i++) {
            if (!rv) {
                return undefined;
            }
            rv = rv[path[i]];
        }
        return rv;
    }

    createElement() {
        // abstract
    }

}


class XISContainer {


}

class CategoryWidget  extends XISRoot {

    createChildren() {
        return [new WidgetHeadline(), new CategoryDiv()];
    }
}


class WidgetHeadline extends XISElement {

    createElement() {
       return createElement('h3');
    }

    createChildren() {
        return [new WidgetHeadlineContent()];
    }
}


class WidgetHeadlineContent extends XISTextNode {
    getText() {
        var text = '';
        text += 'Kategorien';
        return text;
    }
}

class CategoryDiv extends XISLoopElement {

    constructor() {
        super({arrayPath: ['categories'],
            itemVarName: 'category',
            indexVarName: 'categoryIndex',
            numberVarName: 'categoryNumber'});
    }

    createChildren() {
        return [new CategoryH4(), new ProductUl()];
    }

    createElement() {
        return createElement('div');
    }

}



class CategoryH4 extends XISElement{

    createChildren() {
        return [new CategoryHeadline()];
    }

    createElement() {
        return createElement('h4', {style: 'color:red'});
    }
}


class CategoryHeadline extends XISTextNode {

    getText() {
        debugger;
        var text = '';
        text +=  this.parent.getValue(['categoryNumber']); 
        text += ' ';
        text +=  this.parent.getValue(['category', 'title']);   
        return text;
    }

}

class ProductUl extends XISLoopElement {

    constructor() {
        super({arrayPath: ['category','products'],
        itemVarName: 'product',
        indexVarName: 'productIndex',
        numberVarName: 'productNumber'});
    }

    createChildren() {
        return [new ProductLi(this)];
    }

    createElement() {
        return createElement('ul');
    }
}


class ProductLi extends XISElement {
    

    createChildren() {
        return [new ProductDetails()];
    }

    createElement() {
        return createElement('ul');
    }
}


class ProductDetails extends XISTextNode {

    getText() {
        var text = '';
        text += this.parent.getValue(['product', 'title']);
        text += ' ';
        text += this.parent.getValue(['product', 'price']);
        text += ' EUR';
        return text;
    }
}

class CategoryListWidget extends XISRoot {

}

/////////////////////////////////////////////////////////////////// Util Functions /////////////////////////////////////////////



function byId(id) {
    return document.getElementById(id);
}


var widget = new CategoryWidget();
widgeinit(byId('content'));


function buttonClicked() {
   widget.update({categories: categories});
}
